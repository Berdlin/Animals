<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Feral Pursuit - Multiplayer</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #080808;
            color: #ccc;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        .game-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .game-stage {
            flex-grow: 1;
            position: relative;
            background-color: #0a0f0a;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #mapViewport {
            width: 600px;
            height: 600px;
            background-color: #0c180f;
            border: 2px solid #333;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .inventory-sidebar {
            width: 280px;
            background-color: #111;
            border-right: 2px solid #333;
            height: 100vh;
            position: absolute;
            left: 0;
            top: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .inventory-sidebar.visible {
            transform: translateX(0);
        }

        .inv-header {
            padding: 20px;
            background-color: #1a1a1a;
            text-align: center;
            color: #ff4500;
            font-family: 'Georgia', serif;
            font-size: 1.2em;
            border-bottom: 1px solid #333;
        }

        .inv-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .inv-item {
            background: #222;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .key-hint {
            background: #ff4500;
            color: #000;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            font-size: 0.8em;
        }

        .hud-top {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            z-index: 50;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 30px;
            border-radius: 30px;
            border: 1px solid #333;
            pointer-events: none;
        }

        .hud-stat {
            font-size: 1.2em;
            color: #fff;
        }

        .hud-stat span {
            color: #ff4500;
            font-weight: bold;
        }

        .icon {
            position: absolute;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.05s linear;
        }

        .playerIconSelf {
            font-size: 2em;
            width: 40px;
            height: 40px;
            background: #ff4500;
            border-radius: 50%;
            border: 2px solid #fff;
            z-index: 10;
        }

        .playerIconOther {
            font-size: 2em;
            width: 40px;
            height: 40px;
            background: #00bfff;
            border-radius: 50%;
            border: 2px solid #fff;
            z-index: 10;
            opacity: 0.7;
        }

        .nameTag {
            position: absolute;
            top: -20px;
            font-size: 0.7em;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
        }

        #wolfIcon {
            font-size: 2.5em;
            width: 50px;
            height: 50px;
            background: #500;
            border-radius: 50%;
            border: 2px solid #f00;
            z-index: 9;
        }

        .friendlyWolfIcon {
            font-size: 1.5em;
            width: 30px;
            height: 30px;
            background: #00bfff;
            border-radius: 50%;
            border: 2px solid #fff;
            z-index: 9;
        }

        .chest {
            font-size: 1.8em;
            z-index: 8;
            cursor: pointer;
        }

        .chest-bad::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background: red;
            border-radius: 50%;
        }

        #storyText {
            position: absolute;
            top: 80px;
            left: 20px;
            width: 250px;
            text-align: left;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            z-index: 40;
            transition: opacity 0.5s;
            color: #ff4500;
            border: 1px solid #ff4500;
            pointer-events: none;
        }

        #gameOverOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .mobile-controls-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        @media (max-width: 900px) {
            .mobile-controls-layer {
                display: block;
            }

            #mapViewport {
                width: 100%;
                height: 100%;
                border: none;
            }
        }

        #joystickZone {
            position: absolute;
            bottom: 50px;
            left: 40px;
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            pointer-events: auto;
        }

        #joystickKnob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: rgba(255, 69, 0, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .action-btn-group {
            position: absolute;
            bottom: 40px;
            right: 30px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            pointer-events: auto;
        }

        .mob-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(50, 50, 50, 0.9);
            border: 2px solid #fff;
            color: #fff;
            font-weight: bold;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mob-btn:active {
            background: #ff4500;
        }

        #btnAttack {
            width: 90px;
            height: 90px;
            background: rgba(200, 0, 0, 0.7);
            border-color: #ff4500;
            font-size: 2em;
        }

        #btnLoot {
            background: rgba(0, 191, 255, 0.7);
            border-color: #00bfff;
            font-size: 1.5em;
        }

        .small-btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 5px;
        }

        #btnInventory {
            width: 50px;
            height: 50px;
            font-size: 0.8em;
            background: #333;
        }
    </style>
</head>

<body>
    <div class="inventory-sidebar" id="inventory-sidebar">
        <div class="inv-header">INVENTORY (Q/Alt)</div>
        <div class="inv-list" id="invList"></div>
    </div>

    <div class="hud-top">
        <div class="hud-stat">TIME: <span id="timeStat">...</span></div>
        <div class="hud-stat">HP: <span id="hpStat">...</span></div>
        <div class="hud-stat">DMG: <span id="dmgStat">...</span></div>
    </div>

    <div class="game-wrapper">
        <div class="game-stage">
            <div id="mapViewport">
                <div id="wolfIcon" class="icon" style="display:none;">üê∫</div>
                <div id="playersLayer"></div>
                <div id="mapItems"></div>
                <div id="effectsLayer"></div>
            </div>
            <div id="storyText" style="opacity: 1;">Connecting...</div>

            <div class="mobile-controls-layer">
                <div id="joystickZone">
                    <div id="joystickKnob"></div>
                </div>
                <div class="action-btn-group">
                    <div class="small-btn-group">
                        <div class="mob-btn" id="btnInventory" ontouchstart="toggleInventory()">INV</div>
                    </div>
                    <div class="mob-btn" id="btnLoot" ontouchstart="triggerAction('loot')">üëã</div>
                    <div class="mob-btn" id="btnAttack" ontouchstart="triggerAction('attack')">‚öîÔ∏è</div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameOverOverlay" style="display: none;">
        <h1 id="endTitle" style="color:white; font-size:3em;">GAME OVER</h1>
        <p id="endReason" style="color:#aaa; font-size:1.5em;"></p>
        <a href="gameintro.html" style="color:#ff4500; font-size:1.2em; margin-top:20px;">Return to Intro</a>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let myId = null;
        let keyStates = {};
        let gameActive = false;
        let initialMessageCleared = false;
        let joyActive = false;
        let joyData = { x: 0, y: 0 };
        const joyBase = document.getElementById('joystickZone');
        const joyKnob = document.getElementById('joystickKnob');
        const socket = io();
        const getEl = (id) => document.getElementById(id);

        socket.on('connect', () => {
            myId = socket.id;
            const roomCode = localStorage.getItem('gameRoomCode');
            if (roomCode) { console.log(`Connected. Room: ${roomCode}`); }
            else { window.location.href = 'gameintro.html'; }
        });

        socket.on('gameStateUpdate', (state) => {
            if (state.status !== 'lobby' && state.status !== 'over' && !initialMessageCleared) {
                getEl('storyText').style.opacity = '0'; initialMessageCleared = true; gameActive = true;
            }
            if (state.status !== 'over' && state.status !== 'lobby') gameActive = true;
            renderGameState(state);
            if (state.status === 'over') endGame(state.players[myId]?.alive, state.endReason);
        });

        socket.on('hostLeft', (message) => endGame(false, message));

        function sendActionToServer(type, data = {}) { if (gameActive) socket.emit('playerAction', { type, data }); }

        function checkAndSendMovement() {
            if (!gameActive) return;
            let dx = 0, dy = 0;
            if (keyStates['w']) dy--; if (keyStates['s']) dy++;
            if (keyStates['a']) dx--; if (keyStates['d']) dx++;
            if (joyActive) { dx = joyData.x; dy = joyData.y; }
            if (dx || dy) {
                const len = Math.sqrt(dx * dx + dy * dy);
                if (len > 0) sendActionToServer('move', { dx: dx / len, dy: dy / len });
            } else { sendActionToServer('stopMove'); }
        }
        setInterval(checkAndSendMovement, 50);

        function handleDown(e) {
            const k = e.key.toLowerCase();
            let key = k;
            if (k === 'arrowup') key = 'w'; if (k === 'arrowdown') key = 's';
            if (k === 'arrowleft') key = 'a'; if (k === 'arrowright') key = 'd';
            if (['w', 'a', 's', 'd'].includes(key)) keyStates[key] = true;
            if (k === 'e') sendActionToServer('loot');
            if (k === 'q' || k === 'alt') toggleInventory();
            if (k >= '1' && k <= '9') sendActionToServer('useItem', { index: parseInt(k) - 1 });
        }

        function handleUp(e) {
            const k = e.key.toLowerCase();
            let key = k;
            if (k === 'arrowup') key = 'w'; if (k === 'arrowdown') key = 's';
            if (k === 'arrowleft') key = 'a'; if (k === 'arrowright') key = 'd';
            if (['w', 'a', 's', 'd'].includes(key)) keyStates[key] = false;
        }

        window.addEventListener('keydown', handleDown);
        window.addEventListener('keyup', handleUp);

        joyBase.addEventListener('touchstart', (e) => { joyActive = true; updateJoy(e.touches[0]); }, { passive: false });
        joyBase.addEventListener('touchmove', (e) => { if (joyActive) { e.preventDefault(); updateJoy(e.touches[0]); } }, { passive: false });
        joyBase.addEventListener('touchend', () => { joyActive = false; joyData = { x: 0, y: 0 }; joyKnob.style.transform = `translate(-50%,-50%)`; });

        function updateJoy(touch) {
            const rect = joyBase.getBoundingClientRect();
            let dx = touch.clientX - (rect.left + rect.width / 2);
            let dy = touch.clientY - (rect.top + rect.height / 2);
            const dist = Math.sqrt(dx * dx + dy * dy);
            const maxDist = rect.width / 2;
            if (dist > maxDist) { dx = (dx / dist) * maxDist; dy = (dy / dist) * maxDist; }
            joyKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            joyData.x = dx / maxDist; joyData.y = dy / maxDist;
        }

        function triggerAction(act) { if (act === 'loot') sendActionToServer('loot'); }

        function renderGameState(state) {
            const myPlayer = state.players[myId];
            if (myPlayer) {
                getEl('timeStat').textContent = state.timer > 0 ? state.timer : 'FIGHT';
                getEl('hpStat').textContent = myPlayer.alive ? myPlayer.hp : 'DEAD';
                getEl('dmgStat').textContent = myPlayer.dmg;
                renderInventory(myPlayer);
            }
            renderPlayers(state.players);
            const wolf = getEl('wolfIcon');
            if ((state.status === 'chase' || state.status === 'battle') && state.wolf && state.wolf.hp > 0) {
                wolf.style.display = 'flex'; wolf.style.left = state.wolf.x + 'px'; wolf.style.top = state.wolf.y + 'px';
            } else { wolf.style.display = 'none'; }
            const chestCont = getEl('mapItems'); chestCont.innerHTML = '';
            state.chests.forEach((c, i) => {
                if (c.opened) return;
                const el = document.createElement('div'); el.className = 'icon chest';
                if (c.reward.type.includes('bad')) el.classList.add('chest-bad');
                el.textContent = 'üì¶'; el.style.left = c.x + 'px'; el.style.top = c.y + 'px';
                chestCont.appendChild(el);
            });
            if (state.message) msg(state.message);
        }

        function renderPlayers(players) {
            const layer = getEl('playersLayer'); const activeIds = new Set();
            for (const id in players) {
                const p = players[id]; if (!p.alive) continue; activeIds.add(id);
                let el = getEl('player-' + id);
                if (!el) {
                    el = document.createElement('div'); el.className = 'icon ' + (id === myId ? 'playerIconSelf' : 'playerIconOther');
                    el.id = 'player-' + id; el.textContent = 'üèÉ';
                    el.innerHTML += `<div class="nameTag">${p.username}</div>`;
                    const comp = document.createElement('div'); comp.id = 'comp-' + id; comp.className = 'icon friendlyWolfIcon'; comp.textContent = 'üêï';
                    el.appendChild(comp); layer.appendChild(el);
                }
                el.style.left = p.x + 'px'; el.style.top = p.y + 'px';
                const comp = getEl('comp-' + id); comp.style.display = p.companion.active ? 'flex' : 'none';
            }
            Array.from(layer.children).forEach(el => { if (!activeIds.has(el.id.replace('player-', ''))) el.remove(); });
        }

        function renderInventory(player) {
            const list = getEl('invList'); list.innerHTML = '';
            player.inventory.forEach((item, i) => {
                const el = document.createElement('div'); el.className = 'inv-item';
                el.innerHTML = `<span class="key-hint">${i + 1}</span> ${item.icon} ${item.name}`;
                el.onclick = () => sendActionToServer('useItem', { index: i });
                list.appendChild(el);
            });
        }

        function toggleInventory() { getEl('inventory-sidebar').classList.toggle('visible'); }
        function msg(txt) { const t = getEl('storyText'); t.innerText = txt; t.style.opacity = 1; setTimeout(() => { if (initialMessageCleared) t.style.opacity = 0; }, 3000); }
        function endGame(win, reason) {
            getEl('gameOverOverlay').style.display = 'flex';
            getEl('endTitle').textContent = win ? "VICTORY" : "DEFEAT";
            getEl('endReason').textContent = reason;
            gameActive = false;
        }
    </script>
</body>

</html>